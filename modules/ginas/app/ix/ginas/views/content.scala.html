@import ix.ncats.controllers.App
@import ix.ncats.controllers.App.FacetDecorator
@import ix.core.search.FieldFacet

@(title: String, kind: String,
        resetAction: String, current: Int, rows: Int, total: Int,
        pages: Array[Int], facets: Array[FacetDecorator],searchFacets : List[FieldFacet] = null)(header: Html)(breadcrumb: Html)(content: Html)

    @ginas(title, kind) {
        @header
    } {
        @breadcrumb
    } {
        <div class="row">
            @if(total > 0 && facets.length > 0) {
                <div class="col-md-3" id="facet-col">
            <div class="btn btn-primary hidden-md hidden-lg" ng-click ='isCollapsed = !isCollapsed'>
              <i class="fa fa-filter"></i> Toggle Filters
            </div>
            <div collapse="isCollapsed" class="panel-group">
                        @ix.ncats.views.html.filters(facets)                        
                    </div>
                </div>



                <div class="col-md-9">
                } else {
                <div class="col-md-12">
                }
            @defining(App.getUnspecifiedFacets(facets)) { unspecf =>
                @if(request().getQueryString("q") != null || !unspecf.isEmpty()) {
                    <div
                        @if(total > 0) {
                            class="alert alert-success alert-dismissible"
                        } else {
                            class="alert alert-danger alert-dismissible"
                        }
                    role="alert">
                    
                          
                             
                        <button type="button" class="close" data-dismiss="alert"
                        onclick="location.assign('@ix.ginas.controllers.routes.GinasApp.substances().url')"
                        aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        @request().getQueryString("type") match {
						    case "sequence" => {
							    <span><h4>Sequence Query:&nbsp;
							     <a target="_self" href='@ix.ginas.controllers.routes.GinasFactory.sequence(request().getQueryString("q"))'><code>@ix.ginas.controllers.GinasFactory.getSequence(request().getQueryString("q"), 15)</code></a></h4>
				                                </span> <div id="searching"></div>
							    }
                            case "Substructure" => {
                                <span><h4>Substructure Query:&nbsp; <a href="#"
                                tabindex="-1"
                                data-toggle="popover"
                                data-animation="true"
                                data-placement="bottom"
                                data-trigger="click hover focus"
                                data-title=""
                                data-html="true"
                                data-content="<img src='@ix.ncats.controllers.routes.App.render(request().getQueryString("q"), 150)'>"><code>@request().getQueryString("q")</code></a></h4>
                                </span> <div id="searching"></div>
                            }
                            case "Similarity" => {
                                <span><h4>Similarity Query:&nbsp; <a href="#"
                                tabindex="-1"
                                data-toggle="popover"
                                data-animation="true"
                                data-placement="bottom"
                                data-trigger="click hover focus"
                                data-title=""
                                data-html="true"
                                data-content="<img src='@ix.ncats.controllers.routes.App.render(request().getQueryString("q"), 150)'>"><code>@request().getQueryString("q")</code></a> &ge; @request().getQueryString("cutoff")</h4>
                                </span> <div id="searching"></div>
                            }
                            case _ => {
                                @if(request().getQueryString("q") != null) {
                                    <span><h4>Query:&nbsp;<code>@request().getQueryString("q")</code></h4></span>
                                } else {
                                    @for(f <- unspecf) {
                                        <span><h4>@f.substring(0, f.indexOf('/'))
                                            :&nbsp;<code>@f.substring(f.indexOf('/') + 1)</code></h4>
                                        </span>
                                    }
                                }
                            }
                        }
                    </div>
                }
                  @if(searchFacets!=null && searchFacets.size()>0){
                           <div
                        @if(total > 0) {
                            class="alert alert-success alert-dismissible"
                        } else {
                            class="alert alert-danger alert-dismissible"
                        }
                    role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span>
                        </button>
                              <h4>Restrict query to field:</h4>
                              @searchFacets.groupBy(_.matchType).map {
                                    case (group, items) => {
                                        @if(group.toString() == "FULL"){
                                            <h5 style="font-style:italic">Exact Match:</h5>
                                        }else{
                                            <h5 style="font-style:italic">Contains Match:</h5>
                                        }
                                        <div class = "row fieldfacet">
                                        @items.map { item =>
                                        <a target="_self" href='@ix.ginas.controllers.routes.GinasApp.substances().url?q=@item.getLuceneQuery()'>
                                         <button class="btn btn-primary" >  
                                                  <div class = "col-md-4">
                                                  <div class = "row">
                                                    
                                                        
                                                            <span style="color:white">
                                                                @item.getDisplayField()
                                                            </span>
                                                        
                                                        <span class="badge">@item.count</span>
                                                    </div>
                                                </div>
                                            </button>
                                            </a>
                                        }
                                        </div>
                                    }
                                }
                                            <div class="spacer">&nbsp;</div>
                    </div>
                          }
            }

            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="row">
                        <div class = "col-md-9">
                        @ix.ginas.views.html.pagination(current, rows, total, pages)(HtmlFormat.empty)
                        </div>
                        <div class= "col-md-3 text-right hidden-xs">
                            <form class="form" name="grid-select" id = "grid-select">
                            <switch id="enabled" name="enabled" ng-model="enabled" on='<i class="fa fa-th-list fa-2x"></i>' off='<i class="fa fa-th fa-2x"></i>'></switch>
                            </form>
                        </div>
                    </div>
                </div>
                @content

                <div class="panel-footer">
                @if(pages.length > 1) {
                    @ix.ginas.views.html.pagination(current, rows, total, pages)(HtmlFormat.empty)
                }
                </div>
            </div>
        </div>
        </div>
            <div class="modal export" id="loading">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-body">
                            <div id="loading-progress"></div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
function dismissQuery () {
    location.assign('@resetAction');
}

$(document).ready(function () {
   @defining(App.checkStatus()) { status =>
      @if(status != null) {
         $('#searching').html('<i class="fa fa-spinner fa-spin"></i> searching...');
         var delay = 2000; // 2s
         var checkStatus;

         checkStatus = window.setInterval(function () {
             $.get('@status'+'@App.queryString("cutoff")', function(data) {
                  if (data.status == 'Done' || data.status == 'Failed') {
                     window.clearInterval(checkStatus);
                     $('#searching').html('');
                     if(data.count > @total) {
                        location.reload(true);
                     }
                  } else {
                     console.log(data.status);
                     console.log('status '+data.count);
                     $('#searching').html('<i class="fa fa-spinner fa-spin"></i>searching... '+data.count+' matches');
                  }
              });
          }, delay);
       }
  }
});
</script>
    }
